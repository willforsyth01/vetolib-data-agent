name: Vetolib one-off CSV

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        type: choice
        options: [test, full]
        default: test

      max_results:
        description: "Overpass max results per tile"
        type: number
        default: 2000

      tiles:
        description: "Split Berlin bbox into N×N tiles"
        type: number
        default: 2

      geocode:
        description: "Use Nominatim reverse geocoding (slower)"
        type: boolean
        default: false

      enrich_websites:
        description: "Fetch clinic websites to parse opening hours"
        type: boolean
        default: false

      use_google_places:
        description: "Use Google Places API (costs money!)"
        type: boolean
        default: false

jobs:
  build-csv:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Locate crawler + requirements
        id: locate
        shell: bash
        run: |
          set -e
          echo "Repo tree:"
          ls -R .

          CRAWLER="$(git ls-files | grep -E 'vetolib_berlin_crawler\.py$' | head -n 1 || true)"
          REQS="$(git ls-files | grep -E 'requirements\.txt$' | head -n 1 || true)"

          echo "Detected crawler: '$CRAWLER'"
          echo "Detected requirements: '$REQS'"

          test -n "$CRAWLER" || { echo '❌ Missing vetolib_berlin_crawler.py'; exit 1; }

          echo "crawler=$CRAWLER" >> "$GITHUB_OUTPUT"
          echo "reqs=$REQS" >> "$GITHUB_OUTPUT"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -n "${{ steps.locate.outputs.reqs }}" ]; then
            pip install -r "${{ steps.locate.outputs.reqs }}"
          else
            echo "⚠️ No requirements.txt found — continuing."
          fi

      - name: Build flags
        id: cmd
        shell: bash
        env:
          MODE: ${{ github.event.inputs.mode }}
          MAX_RESULTS: ${{ github.event.inputs.max_results }}
          TILES: ${{ github.event.inputs.tiles }}
          GEOCODE: ${{ github.event.inputs.geocode }}
          ENRICH: ${{ github.event.inputs.enrich_websites }}
          GOOGLE: ${{ github.event.inputs.use_google_places }}
        run: |
          set -e

          if [ "$MODE" = "full" ]; then
            MAX_RESULTS="${MAX_RESULTS:-5000}"
            TILES="${TILES:-3}"
            GEOCODE="${GEOCODE:-true}"
            ENRICH="${ENRICH:-true}"
          fi

          FLAGS="--city Berlin --max-results ${MAX_RESULTS} --tiles ${TILES}"

          if [ "$GEOCODE" = "false" ]; then FLAGS="$FLAGS --no-geocode"; fi
          if [ "$ENRICH" = "true" ]; then FLAGS="$FLAGS --enrich-websites"; fi
          if [ "$GOOGLE" = "true" ]; then FLAGS="$FLAGS --use-google-places"; fi

          echo "flags=$FLAGS" >> "$GITHUB_OUTPUT"
          echo "Final flags: $FLAGS"

      - name: Run Vetolib crawler
        env:
          NOMINATIM_EMAIL: ${{ secrets.NOMINATIM_EMAIL }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        shell: bash
        run: |
          set -e

          echo "Running crawler: python \"${{ steps.locate.outputs.crawler }}\" ${{ steps.cmd.outputs.flags }}"
          
          for i in 1 2 3; do
            python "${{ steps.locate.outputs.crawler }}" ${{ steps.cmd.outputs.flags }} && break || {
              echo "Attempt $i failed — retrying..."
              sleep $((10*i))
            }
          done

          echo "Crawler finished."
          echo "Workspace after crawler:"
          ls -la .

          echo "Searching for CSV/JSONL:"
          find . -maxdepth 3 -type f \( -name '*.csv' -o -name '*.jsonl' \) -print || true

      - name: Create sanity CSV
        shell: bash
        run: |
          echo "col1,col2" > sanity.csv
          echo "1,2" >> sanity.csv
          echo "Created sanity.csv"
          echo "Workspace now contains:"
          ls -la .

      - name: Upload ALL CSV + JSONL outputs
        uses: actions/upload-artifact@v4
        with:
          name: vetolib-berlin-${{ github.event.inputs.mode || 'test' }}
          path: |
            **/*.csv
            **/*.jsonl
          if-no-files-found: error
