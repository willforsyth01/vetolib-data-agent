name: Vetolib full Berlin CSV

on:
  workflow_dispatch: {}   # manual trigger

jobs:
  build-csv:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Locate crawler and requirements
        id: locate
        shell: bash
        run: |
          set -e
          echo "Repo contents:"
          ls -la
          CRAWLER="$(git ls-files | grep -E '(^|/|\\)vetolib_berlin_crawler\.py$' | head -n 1 || true)"
          REQS="$(git ls-files | grep -E '(^|/|\\)requirements\.txt$' | head -n 1 || true)"
          if [ -z "$CRAWLER" ]; then echo "❌ Missing vetolib_berlin_crawler.py"; exit 1; fi
          if [ -z "$REQS" ]; then echo "❌ Missing requirements.txt"; exit 1; fi
          echo "crawler=$CRAWLER" >> "$GITHUB_OUTPUT"
          echo "reqs=$REQS" >> "$GITHUB_OUTPUT"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r "${{ steps.locate.outputs.reqs }}"

      - name: Detect supported flags
        id: flags
        shell: bash
        run: |
          HELP_OUT="$(python "${{ steps.locate.outputs.crawler }}" --help || true)"
          if echo "$HELP_OUT" | grep -q -- '--tiles'; then
            echo 'cmd=python "${{ steps.locate.outputs.crawler }}" --city "Berlin" --max-results 5000 --tiles 3 --output-dir "./out" --enrich-websites' >> "$GITHUB_OUTPUT"
          else
            echo 'cmd=python "${{ steps.locate.outputs.crawler }}"' >> "$GITHUB_OUTPUT"
          fi

      - name: Run Vetolib crawler (full mode)
        env:
          NOMINATIM_EMAIL: ${{ secrets.NOMINATIM_EMAIL }}
        shell: bash
        run: |
          set -e
          mkdir -p out
          echo "Executing full crawler: ${{ steps.flags.outputs.cmd }}"
          # Retry up to 3 times in case Overpass throttles
          for i in 1 2 3; do
            eval ${{ steps.flags.outputs.cmd }} && break || { echo "Attempt $i failed; retrying..."; sleep 15; }
          done
          echo "Run finished."
          ls -la out || true

      - name: Upload CSV/JSONL artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vetolib-berlin-full
          path: |
            out/clinics_berlin.csv
            out/clinics_berlin.jsonl
          if-no-files-found: warn
