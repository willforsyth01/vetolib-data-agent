name: Vetolib one-off CSV

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        type: choice
        options: [test, full]
        default: test

      max_results:
        description: "Overpass max results per tile"
        type: number
        default: 2000

      tiles:
        description: "Split Berlin bbox into N×N tiles"
        type: number
        default: 2

      geocode:
        description: "Use Nominatim reverse geocoding (slower)"
        type: boolean
        default: false

      enrich_websites:
        description: "Fetch clinic websites to parse opening hours"
        type: boolean
        default: false

      use_google_places:
        description: "Use Google Places API (costs money!)"
        type: boolean
        default: false

jobs:
  build-csv:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, continuing..."
          fi

      - name: Build flags
        id: cmd
        shell: bash
        env:
          MODE: ${{ github.event.inputs.mode }}
          MAX_RESULTS: ${{ github.event.inputs.max_results }}
          TILES: ${{ github.event.inputs.tiles }}
          GEOCODE: ${{ github.event.inputs.geocode }}
          ENRICH: ${{ github.event.inputs.enrich_websites }}
          GOOGLE: ${{ github.event.inputs.use_google_places }}
        run: |
          set -e

          if [ "$MODE" = "full" ]; then
            MAX_RESULTS="${MAX_RESULTS:-5000}"
            TILES="${TILES:-3}"
            GEOCODE="${GEOCODE:-true}"
            ENRICH="${ENRICH:-true}"
          fi

          FLAGS="--city Berlin --max-results ${MAX_RESULTS} --tiles ${TILES}"

          if [ "$GEOCODE" = "false" ]; then
            FLAGS="$FLAGS --no-geocode"
          fi
          if [ "$ENRICH" = "true" ]; then
            FLAGS="$FLAGS --enrich-websites"
          fi
          if [ "$GOOGLE" = "true" ]; then
            FLAGS="$FLAGS --use-google-places"
          fi

          echo "flags=$FLAGS" >> "$GITHUB_OUTPUT"
          echo "✅ Final flags: $FLAGS"

      - name: Run Vetolib crawler
        env:
          NOMINATIM_EMAIL: ${{ secrets.NOMINATIM_EMAIL }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        shell: bash
        run: |
          set -e

          echo "Running crawler:"
          echo "python vetolib_berlin_crawler.py ${{ steps.cmd.outputs.flags }}"

          for i in 1 2 3; do
            python vetolib_berlin_crawler.py ${{ steps.cmd.outputs.flags }} && break || {
              echo "Attempt $i failed, retrying..."
              sleep $((10*i))
            }
          done

          echo "Run complete. Listing files in workspace:"
          ls -la

          echo "Searching for any CSV/JSONL outputs:"
          find . -maxdepth 4 -type f \( -name '*.csv' -o -name '*.jsonl' \) -print || true

      - name: Upload ALL CSV + JSONL outputs
        uses: actions/upload-artifact@v4
        with:
          name: vetolib-berlin-${{ github.event.inputs.mode || 'test' }}
          path: |
            **/*.csv
            **/*.jsonl
          if-no-files-found: error
